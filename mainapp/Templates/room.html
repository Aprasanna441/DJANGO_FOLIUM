{% extends 'base.html' %}
 {% block title %}-Chat Room{% endblock %} 
 {% block content %}

 <p id="loc"></p>
 <div id="map" style="width: 100%; height: 600px;"></div>

<input id="chat-message-submit" type="button"  style="text-align:center;" value="Share" />
{{ room_name|json_script:"room-name" }}


<script>
  const roomName = JSON.parse(document.getElementById("room-name").textContent);


  navigator.geolocation.getCurrentPosition(function (position) {
    sessionStorage.setItem("latitude", position.coords.latitude+1);
        sessionStorage.setItem("longitude", position.coords.longitude+12);
       
        
  })
        


 
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/" + roomName + "/"
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    document.querySelector("#loc").innerHTML+= data.message + "\n";
    console.log(data.message[0])
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

 

  // document.querySelector('#chat-message-submit').onclick = function(e) {
  // const messageInputDom = document.querySelector('#chat-message-input');

  function refreshLocation() {
    // const message = messageInputDom.value;
    if ("geolocation" in navigator) {
       
      // Get the user's current position
      navigator.geolocation.getCurrentPosition(function (position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        var accuracy = position.coords.accuracy;
        
        const message = [longitude, latitude];
        
       

        if (
          sessionStorage.getItem("longitude") == longitude &&
          sessionStorage.getItem("latitude") == latitude
        ) 
        {
        } else {
            console.log("changed")
          sessionStorage.setItem("longitude", longitude);
          sessionStorage.setItem("latitude", latitude);
          chatSocket.send(
            JSON.stringify({
              message: message,
            })
          );
        }
       

      

        var map = L.map('map').setView([latitude, longitude], 10);
        var container = L.DomUtil.get('map');
      if(container != null){
        container._leaflet_id = null;
      }
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        L.marker([latitude, longitude]).addTo(map)
            .bindPopup(longitude)
            .openPopup();
       
           
      });
    }
  }
  setInterval(refreshLocation,500)
   
// refreshLocation()
</script>
{% endblock %}
